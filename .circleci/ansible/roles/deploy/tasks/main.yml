---
- name: Run app
  shell: kubectl run todo-list-api --image=$DOCKER_IMAGE --port=3000 --labels app=todo
  environment:
    DOCKER_IMAGE: "{{ lookup('env','DOCKER_IMAGE') }}"

- name: Allow external traffic
  become: true
  shell: |
    systemctl enable --now atd.service
    echo "kubectl port-forward --address 0.0.0.0 todo-list-api 3000:3000 </dev/null >/dev/null 2>&1 &" > port_forward.sh
    chmod +x port_forward.sh
    at now + 1 minute -f port_forward.sh
    sleep 60